{"version":3,"sources":["../../../app/api/metrics/store.ts"],"sourcesContent":["type ByDayCount = { [dateISO: string]: number };\ntype ByDayTidSet = { [dateISO: string]: Set<string> };\n\ntype AgencyMapCount = { [agencyEmail: string]: ByDayCount };\ntype AgencyMapTidSet = { [agencyEmail: string]: ByDayTidSet };\n\nconst sends: AgencyMapCount = {};\nconst opens: AgencyMapTidSet = {};\nconst clicks: AgencyMapTidSet = {};\n\nexport function todayISO(d = new Date()) {\n  return d.toISOString().slice(0, 10);\n}\n\nfunction ensureCount(map: AgencyMapCount, agency: string, day: string) {\n  if (!map[agency]) map[agency] = {};\n  if (!map[agency][day]) map[agency][day] = 0;\n}\nfunction ensureSet(map: AgencyMapTidSet, agency: string, day: string) {\n  if (!map[agency]) map[agency] = {};\n  if (!map[agency][day]) map[agency][day] = new Set<string>();\n}\n\nexport function recordSend(agencyEmail: string, day: string, count: number) {\n  if (!agencyEmail || !day || !Number.isFinite(count)) return;\n  ensureCount(sends, agencyEmail, day);\n  sends[agencyEmail][day] += Math.max(0, count);\n}\nexport function recordOpen(agencyEmail: string, day: string, tid: string) {\n  if (!agencyEmail || !day || !tid) return;\n  ensureSet(opens, agencyEmail, day);\n  opens[agencyEmail][day].add(tid);\n}\nexport function recordClick(agencyEmail: string, day: string, tid: string) {\n  if (!agencyEmail || !day || !tid) return;\n  ensureSet(clicks, agencyEmail, day);\n  clicks[agencyEmail][day].add(tid);\n}\n\nexport function getStats(agencyEmail: string, days: number) {\n  const out: Array<{ date: string; sends: number; opens: number; clicks: number }> = [];\n  const base = new Date();\n  let totalSends = 0;\n  let totalOpens = 0;\n  for (let i = days - 1; i >= 0; i--) {\n    const d = new Date(base);\n    d.setDate(base.getDate() - i);\n    const k = todayISO(d);\n    const s = sends[agencyEmail]?.[k] || 0;\n    const o = opens[agencyEmail]?.[k]?.size || 0;\n    const c = clicks[agencyEmail]?.[k]?.size || 0;\n    totalSends += s;\n    totalOpens += o;\n    out.push({ date: k, sends: s, opens: o, clicks: c });\n  }\n  const openRate = totalSends > 0 ? totalOpens / totalSends : 0;\n  return { days: out, totals: { sends: totalSends, opens: totalOpens }, openRate };\n}\n\n\n"],"names":[],"mappings":"uCAMA,IAAM,EAAwB,CAAC,EACzB,EAAyB,CAAC,EAC1B,EAA0B,CAAC,EAE1B,SAAS,EAAS,EAAI,IAAI,IAAM,EACrC,OAAO,EAAE,WAAW,GAAG,KAAK,CAAC,EAAG,GAClC,CAMA,SAAS,EAAU,CAAoB,CAAE,CAAc,CAAE,CAAW,EAC9D,AAAC,CAAG,CAAC,EAAO,GAAE,CAAG,CAAC,EAAO,CAAG,EAAC,EAC7B,AAAC,CAAG,CAAC,EAAO,CAAC,EAAI,GAAE,CAAG,CAAC,EAAO,CAAC,EAAI,CAAG,IAAI,GAAA,CAChD,CAEO,SAAS,EAAW,CAAmB,CAAE,CAAW,CAAE,CAAa,EACpE,AAAC,GAAgB,GAAQ,IAAD,GAAQ,EAAhB,MAAwB,CAAC,KATzC,AAAC,CAAG,CAAC,CAS4C,CATrC,GAAE,CAAG,CAAC,EAAO,CAAG,EAAC,EAC7B,AAAC,CAAG,CAAC,EAAO,CAAC,EAAI,GAAE,AASX,CATc,CAAC,AASR,EATe,CAAC,AASH,EATO,EAAG,EAU1C,CAAK,CAAC,EAAY,CAAC,EAAI,EAAI,KAAK,GAAG,CAAC,EAAG,GACzC,CACO,SAAS,EAAW,CAAmB,CAAE,CAAW,CAAE,CAAW,EACjE,GAAgB,GAAQ,IAAD,AAC5B,CADkC,CACxB,EAAO,CADG,CACU,GAC9B,CAAK,CAAC,EAAY,CAAC,EAAI,CAAC,GAAG,CAAC,GAC9B,CACO,SAAS,EAAY,CAAmB,CAAE,CAAW,CAAE,CAAW,EAClE,GAAgB,GAAQ,IAAD,AAC5B,CADkC,CACxB,EAAQ,CADE,CACW,GAC/B,CAAM,CAAC,EAAY,CAAC,EAAI,CAAC,GAAG,CAAC,GAC/B,CAEO,SAAS,EAAS,CAAmB,CAAE,CAAY,EACxD,IAAM,EAA6E,EAAE,CAC/E,EAAO,IAAI,KACb,EAAa,EACb,EAAa,EACjB,IAAK,IAAI,EAAI,EAAO,EAAG,GAAK,EAAG,IAAK,CAClC,IAAM,EAAI,IAAI,KAAK,GACnB,EAAE,OAAO,CAAC,EAAK,OAAO,GAAK,GAC3B,IAAM,EAAI,EAAS,GACb,EAAI,CAAK,CAAC,EAAY,EAAE,CAAC,EAAE,EAAI,EAC/B,EAAI,CAAK,CAAC,EAAY,EAAE,CAAC,EAAE,EAAE,MAAQ,EACrC,EAAI,CAAM,CAAC,EAAY,EAAE,CAAC,EAAE,EAAE,MAAQ,EAC5C,GAAc,EACd,GAAc,EACd,EAAI,IAAI,CAAC,CAAE,KAAM,EAAG,MAAO,EAAG,MAAO,EAAG,OAAQ,CAAE,EACpD,CACA,IAAM,EAAW,EAAa,EAAI,EAAa,EAAa,EAC5D,MAAO,CAAE,KAAM,EAAK,OAAQ,CAAE,MAAO,EAAY,MAAO,CAAW,WAAG,CAAS,CACjF"}