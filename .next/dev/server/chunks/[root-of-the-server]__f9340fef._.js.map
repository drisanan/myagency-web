{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/mrjames/Desktop/athletenarrative/web/web-app/app/api/google/tokenStore.ts"],"sourcesContent":["export type TokenData = {\n  access_token?: string;\n  refresh_token?: string;\n  scope?: string;\n  token_type?: string;\n  expiry_date?: number;\n};\n\n// WARNING: In-memory store is only for local testing. Replace with a secure DB in production.\nconst TOKENS: Record<string, TokenData> = {};\n\nexport function saveTokens(clientId: string, tokens: TokenData) {\n  const key = clientId || 'default';\n  console.info('[gmail-token:save]', {\n    clientId: key,\n    hasAccess: Boolean(tokens?.access_token),\n    hasRefresh: Boolean(tokens?.refresh_token),\n    expiry: tokens?.expiry_date,\n  });\n  TOKENS[key] = { ...(TOKENS[key] || {}), ...tokens };\n}\n\nexport function getTokens(clientId: string): TokenData | undefined {\n  const key = clientId || 'default';\n  const t = TOKENS[key];\n  console.info('[gmail-token:get]', {\n    clientId: key,\n    exists: Boolean(t),\n    hasAccess: Boolean(t?.access_token),\n    hasRefresh: Boolean(t?.refresh_token),\n  });\n  return t;\n}\n\nexport function clearTokens(clientId?: string) {\n  if (clientId) {\n    delete TOKENS[clientId];\n  } else {\n    Object.keys(TOKENS).forEach((k) => delete TOKENS[k]);\n  }\n}\n\n\n"],"names":[],"mappings":";;;;;;;;AAQA,8FAA8F;AAC9F,MAAM,SAAoC,CAAC;AAEpC,SAAS,WAAW,QAAgB,EAAE,MAAiB;IAC5D,MAAM,MAAM,YAAY;IACxB,QAAQ,IAAI,CAAC,sBAAsB;QACjC,UAAU;QACV,WAAW,QAAQ,QAAQ;QAC3B,YAAY,QAAQ,QAAQ;QAC5B,QAAQ,QAAQ;IAClB;IACA,MAAM,CAAC,IAAI,GAAG;QAAE,GAAI,MAAM,CAAC,IAAI,IAAI,CAAC,CAAC;QAAG,GAAG,MAAM;IAAC;AACpD;AAEO,SAAS,UAAU,QAAgB;IACxC,MAAM,MAAM,YAAY;IACxB,MAAM,IAAI,MAAM,CAAC,IAAI;IACrB,QAAQ,IAAI,CAAC,qBAAqB;QAChC,UAAU;QACV,QAAQ,QAAQ;QAChB,WAAW,QAAQ,GAAG;QACtB,YAAY,QAAQ,GAAG;IACzB;IACA,OAAO;AACT;AAEO,SAAS,YAAY,QAAiB;IAC3C,IAAI,UAAU;QACZ,OAAO,MAAM,CAAC,SAAS;IACzB,OAAO;QACL,OAAO,IAAI,CAAC,QAAQ,OAAO,CAAC,CAAC,IAAM,OAAO,MAAM,CAAC,EAAE;IACrD;AACF"}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///Users/mrjames/Desktop/athletenarrative/web/web-app/app/api/gmail/utils.ts"],"sourcesContent":["export function toBase64Url(str: string) {\n  return Buffer.from(str)\n    .toString('base64')\n    .replace(/\\+/g, '-')\n    .replace(/\\//g, '_')\n    .replace(/=+$/, '');\n}\n\n\n"],"names":[],"mappings":";;;;AAAO,SAAS,YAAY,GAAW;IACrC,OAAO,OAAO,IAAI,CAAC,KAChB,QAAQ,CAAC,UACT,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,OAAO;AACpB"}},
    {"offset": {"line": 102, "column": 0}, "map": {"version":3,"sources":["file:///Users/mrjames/Desktop/athletenarrative/web/web-app/app/api/gmail/create-draft/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { getTokens } from '../../google/tokenStore';\nimport { toBase64Url } from '../utils';\n\nfunction stripMailto(s: string): string {\n  let out = s.trim();\n  if (out.toLowerCase().startsWith('mailto:')) {\n    out = out.slice(7);\n  }\n  const q = out.indexOf('?');\n  if (q >= 0) out = out.slice(0, q);\n  return out.trim();\n}\n\nfunction extractAngleBracketEmails(s: string): string[] {\n  const out: string[] = [];\n  const regex = /<([^<>\\s@]+@[^<>\\s@]+\\.[^<>\\s@]+)>/g;\n  let m: RegExpExecArray | null;\n  while ((m = regex.exec(s)) !== null) {\n    out.push(m[1]);\n  }\n  return out;\n}\n\nfunction splitEmails(input: string): string[] {\n  return input\n    .split(/[,\\s;]+/g)\n    .map((s) => s.trim())\n    .filter(Boolean);\n}\n\nfunction isValidEmail(s: string): boolean {\n  return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(s) && !/[\\r\\n]/.test(s);\n}\n\nexport async function POST(req: NextRequest) {\n  try {\n    const { clientId, to, subject, html, tokens: inlineTokens } = (await req.json()) as {\n      clientId: string;\n      to: string[];\n      subject: string;\n      html: string;\n      tokens?: any;\n    };\n\n    console.info('[gmail-draft:start]', {\n      clientId,\n      toCount: to?.length || 0,\n      subjectLength: subject?.length || 0,\n      hasInlineTokens: Boolean(inlineTokens),\n    });\n\n    if (!clientId) return NextResponse.json({ ok: false, error: 'Missing clientId' }, { status: 400 });\n    if (!to?.length) return NextResponse.json({ ok: false, error: 'Missing recipients' }, { status: 400 });\n\n    const candidates: string[] = [];\n    (to || []).forEach((raw) => {\n      if (typeof raw !== 'string') return;\n      // Prefer angle-bracket extraction if present: \"Name <email@domain>\"\n      const angled = extractAngleBracketEmails(raw);\n      if (angled.length) {\n        angled.forEach((e) => candidates.push(e));\n        return;\n      }\n      // Otherwise split on separators and strip mailto/query and quotes\n      splitEmails(raw).forEach((tok) => {\n        const cleaned = stripMailto(tok.replace(/^[\"'()]+|[\"'()]+$/g, ''));\n        if (cleaned) candidates.push(cleaned);\n      });\n    });\n    const validRecipients = Array.from(new Set(candidates.filter(isValidEmail)));\n    console.info('[gmail-draft:recipients]', {\n      clientId,\n      requested: to?.length || 0,\n      candidates: candidates.length,\n      valid: validRecipients.length,\n    });\n    if (!validRecipients.length) {\n      return NextResponse.json({ ok: false, error: 'No valid recipient emails' }, { status: 400 });\n    }\n\n    const storeTokens = getTokens(clientId);\n    const tokens = inlineTokens || storeTokens;\n    console.info('[gmail-draft:tokens]', {\n      clientId,\n      inline: Boolean(inlineTokens),\n      exists: Boolean(tokens),\n      hasAccess: Boolean(tokens?.access_token),\n      hasRefresh: Boolean(tokens?.refresh_token),\n    });\n    if (!tokens?.refresh_token && !tokens?.access_token) {\n      console.warn('[gmail-draft:unauthorized]', { clientId });\n      return NextResponse.json({ ok: false, error: 'Gmail not connected for this client' }, { status: 401 });\n    }\n\n    const { google } = await import('googleapis');\n    const oAuth2Client = new google.auth.OAuth2(\n      process.env.GOOGLE_CLIENT_ID,\n      process.env.GOOGLE_CLIENT_SECRET,\n      process.env.GOOGLE_REDIRECT_URI\n    );\n    oAuth2Client.setCredentials(tokens);\n\n    const gmail = google.gmail({ version: 'v1', auth: oAuth2Client });\n\n    // RFC 2047 encode subject to safely include unicode in header\n    const encodedSubjectHeader = subject\n      ? `Subject: =?UTF-8?B?${Buffer.from(subject).toString('base64')}?=`\n      : 'Subject: ';\n    console.log('[gmail-draft:pre = to-header]', { recipients: validRecipients });\n    const toHeader = validRecipients.join(', ');\n    console.info('[gmail-draft:to-header]', { toHeader, recipients: validRecipients });\n\n    const raw = [\n      `To: ${toHeader}`,\n      encodedSubjectHeader,\n      'MIME-Version: 1.0',\n      'Content-Type: text/html; charset=utf-8',\n      '',\n      html || '',\n    ].join('\\r\\n');\n\n    const encoded = toBase64Url(raw);\n    const draft = await gmail.users.drafts.create({\n      userId: 'me',\n      requestBody: { message: { raw: encoded } },\n    });\n\n    const openUrl = `https://mail.google.com/mail/u/0/#search/${encodeURIComponent(`in:drafts subject:\\\"${subject}\\\"`)}`;\n    console.info('[gmail-draft:success]', { clientId, draftId: draft.data.id, messageId: draft.data.message?.id });\n\n    // TODO: audit log (agency, impersonatedBy, clientId, to, subject, draftId)\n    return NextResponse.json({ ok: true, id: draft.data.id, messageId: draft.data.message?.id, openUrl });\n  } catch (e: any) {\n    const detail =\n      e?.response?.data?.error?.message ||\n      e?.response?.data?.error ||\n      e?.message ||\n      'Failed to create draft';\n    console.error('[gmail-draft:error]', { detail });\n    return NextResponse.json({ ok: false, error: detail }, { status: 500 });\n  }\n}\n\n\n"],"names":[],"mappings":"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"}}]
}