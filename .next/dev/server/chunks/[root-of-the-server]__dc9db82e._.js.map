{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///Users/mrjames/Desktop/athletenarrative/web/web-app/app/api/forms/token.ts"],"sourcesContent":["import crypto from 'crypto';\n\nconst ALG = 'sha256';\nconst SECRET = process.env.FORMS_SECRET || 'dev-forms-secret-change-me';\n\nexport function sign(payload: object): string {\n  const header = { alg: 'HS256', typ: 'JWT' };\n  const enc = (o: any) => Buffer.from(JSON.stringify(o)).toString('base64url');\n  const head = enc(header);\n  const body = enc(payload);\n  const hmac = crypto.createHmac(ALG, SECRET).update(`${head}.${body}`).digest('base64url');\n  return `${head}.${body}.${hmac}`;\n}\n\nexport function verify<T = any>(token: string): T | null {\n  const parts = token.split('.');\n  if (parts.length !== 3) return null;\n  const [head, body, sig] = parts;\n  const hmac = crypto.createHmac(ALG, SECRET).update(`${head}.${body}`).digest('base64url');\n  if (hmac !== sig) return null;\n  try {\n    const json = JSON.parse(Buffer.from(body, 'base64url').toString('utf-8'));\n    if (json.exp && Date.now() > Number(json.exp)) return null;\n    return json as T;\n  } catch {\n    return null;\n  }\n}\n\n\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,MAAM;AACZ,MAAM,SAAS,QAAQ,GAAG,CAAC,YAAY,IAAI;AAEpC,SAAS,KAAK,OAAe;IAClC,MAAM,SAAS;QAAE,KAAK;QAAS,KAAK;IAAM;IAC1C,MAAM,MAAM,CAAC,IAAW,OAAO,IAAI,CAAC,KAAK,SAAS,CAAC,IAAI,QAAQ,CAAC;IAChE,MAAM,OAAO,IAAI;IACjB,MAAM,OAAO,IAAI;IACjB,MAAM,OAAO,gHAAM,CAAC,UAAU,CAAC,KAAK,QAAQ,MAAM,CAAC,GAAG,KAAK,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC;IAC7E,OAAO,GAAG,KAAK,CAAC,EAAE,KAAK,CAAC,EAAE,MAAM;AAClC;AAEO,SAAS,OAAgB,KAAa;IAC3C,MAAM,QAAQ,MAAM,KAAK,CAAC;IAC1B,IAAI,MAAM,MAAM,KAAK,GAAG,OAAO;IAC/B,MAAM,CAAC,MAAM,MAAM,IAAI,GAAG;IAC1B,MAAM,OAAO,gHAAM,CAAC,UAAU,CAAC,KAAK,QAAQ,MAAM,CAAC,GAAG,KAAK,CAAC,EAAE,MAAM,EAAE,MAAM,CAAC;IAC7E,IAAI,SAAS,KAAK,OAAO;IACzB,IAAI;QACF,MAAM,OAAO,KAAK,KAAK,CAAC,OAAO,IAAI,CAAC,MAAM,aAAa,QAAQ,CAAC;QAChE,IAAI,KAAK,GAAG,IAAI,KAAK,GAAG,KAAK,OAAO,KAAK,GAAG,GAAG,OAAO;QACtD,OAAO;IACT,EAAE,OAAM;QACN,OAAO;IACT;AACF"}},
    {"offset": {"line": 145, "column": 0}, "map": {"version":3,"sources":["file:///Users/mrjames/Desktop/athletenarrative/web/web-app/infra/src/lib/session.ts"],"sourcesContent":["import { APIGatewayProxyEventV2 } from 'aws-lambda';\nimport { createHmac, timingSafeEqual } from 'crypto';\nimport { SessionContext } from './models';\n\nconst SECRET = process.env.SESSION_SECRET || 'dev-secret-change-me';\nconst COOKIE_NAME = 'an_session';\n\nfunction sign(payload: string) {\n  const sig = createHmac('sha256', SECRET).update(payload).digest('base64url');\n  return `${payload}.${sig}`;\n}\n\nfunction verify(token: string) {\n  const idx = token.lastIndexOf('.');\n  if (idx < 0) return null;\n  const payload = token.slice(0, idx);\n  const sig = token.slice(idx + 1);\n  const expected = createHmac('sha256', SECRET).update(payload).digest('base64url');\n  const a = Buffer.from(sig);\n  const b = Buffer.from(expected);\n  if (a.length !== b.length || !timingSafeEqual(a, b)) return null;\n  try {\n    return JSON.parse(Buffer.from(payload, 'base64url').toString('utf8')) as SessionContext;\n  } catch {\n    return null;\n  }\n}\n\nexport function encodeSession(session: SessionContext) {\n  const payload = Buffer.from(JSON.stringify(session)).toString('base64url');\n  return sign(payload);\n}\n\nexport function parseSession(token?: string | null): SessionContext | null {\n  if (!token) return null;\n  return verify(token);\n}\n\nfunction parseCookie(header?: string): Record<string, string> {\n  if (!header) return {};\n  return header.split(';').reduce<Record<string, string>>((acc, part) => {\n    const [k, v] = part.trim().split('=');\n    if (k && v) acc[k] = v;\n    return acc;\n  }, {});\n}\n\nexport function parseSessionFromRequest(event: APIGatewayProxyEventV2): SessionContext | null {\n  const cookieHeader = event.headers.cookie || event.headers.Cookie;\n  const cookies = parseCookie(cookieHeader);\n  const token = cookies[COOKIE_NAME];\n  return parseSession(token);\n}\n\nexport function buildSessionCookie(token: string) {\n  const attrs = [\n    `${COOKIE_NAME}=${token}`,\n    'HttpOnly',\n    'Path=/',\n    'SameSite=Lax',\n    'Secure',\n    'Max-Age=604800', // 7d\n  ];\n  return attrs.join('; ');\n}\n\nexport function buildClearCookie() {\n  const attrs = [`${COOKIE_NAME}=; Path=/; Max-Age=0; HttpOnly; SameSite=Lax; Secure`];\n  return attrs.join('; ');\n}\n\n"],"names":[],"mappings":";;;;;;;;;;;;AACA;;AAGA,MAAM,SAAS,QAAQ,GAAG,CAAC,cAAc,IAAI;AAC7C,MAAM,cAAc;AAEpB,SAAS,KAAK,OAAe;IAC3B,MAAM,MAAM,IAAA,mHAAU,EAAC,UAAU,QAAQ,MAAM,CAAC,SAAS,MAAM,CAAC;IAChE,OAAO,GAAG,QAAQ,CAAC,EAAE,KAAK;AAC5B;AAEA,SAAS,OAAO,KAAa;IAC3B,MAAM,MAAM,MAAM,WAAW,CAAC;IAC9B,IAAI,MAAM,GAAG,OAAO;IACpB,MAAM,UAAU,MAAM,KAAK,CAAC,GAAG;IAC/B,MAAM,MAAM,MAAM,KAAK,CAAC,MAAM;IAC9B,MAAM,WAAW,IAAA,mHAAU,EAAC,UAAU,QAAQ,MAAM,CAAC,SAAS,MAAM,CAAC;IACrE,MAAM,IAAI,OAAO,IAAI,CAAC;IACtB,MAAM,IAAI,OAAO,IAAI,CAAC;IACtB,IAAI,EAAE,MAAM,KAAK,EAAE,MAAM,IAAI,CAAC,IAAA,wHAAe,EAAC,GAAG,IAAI,OAAO;IAC5D,IAAI;QACF,OAAO,KAAK,KAAK,CAAC,OAAO,IAAI,CAAC,SAAS,aAAa,QAAQ,CAAC;IAC/D,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS,cAAc,OAAuB;IACnD,MAAM,UAAU,OAAO,IAAI,CAAC,KAAK,SAAS,CAAC,UAAU,QAAQ,CAAC;IAC9D,OAAO,KAAK;AACd;AAEO,SAAS,aAAa,KAAqB;IAChD,IAAI,CAAC,OAAO,OAAO;IACnB,OAAO,OAAO;AAChB;AAEA,SAAS,YAAY,MAAe;IAClC,IAAI,CAAC,QAAQ,OAAO,CAAC;IACrB,OAAO,OAAO,KAAK,CAAC,KAAK,MAAM,CAAyB,CAAC,KAAK;QAC5D,MAAM,CAAC,GAAG,EAAE,GAAG,KAAK,IAAI,GAAG,KAAK,CAAC;QACjC,IAAI,KAAK,GAAG,GAAG,CAAC,EAAE,GAAG;QACrB,OAAO;IACT,GAAG,CAAC;AACN;AAEO,SAAS,wBAAwB,KAA6B;IACnE,MAAM,eAAe,MAAM,OAAO,CAAC,MAAM,IAAI,MAAM,OAAO,CAAC,MAAM;IACjE,MAAM,UAAU,YAAY;IAC5B,MAAM,QAAQ,OAAO,CAAC,YAAY;IAClC,OAAO,aAAa;AACtB;AAEO,SAAS,mBAAmB,KAAa;IAC9C,MAAM,QAAQ;QACZ,GAAG,YAAY,CAAC,EAAE,OAAO;QACzB;QACA;QACA;QACA;QACA;KACD;IACD,OAAO,MAAM,IAAI,CAAC;AACpB;AAEO,SAAS;IACd,MAAM,QAAQ;QAAC,GAAG,YAAY,oDAAoD,CAAC;KAAC;IACpF,OAAO,MAAM,IAAI,CAAC;AACpB"}},
    {"offset": {"line": 223, "column": 0}, "map": {"version":3,"sources":["file:///Users/mrjames/Desktop/athletenarrative/web/web-app/infra/src/handlers/common.ts"],"sourcesContent":["import { APIGatewayProxyEventV2, APIGatewayProxyResultV2 } from 'aws-lambda';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient } from '@aws-sdk/lib-dynamodb';\nimport { SessionContext } from '../lib/models';\nimport { parseSessionFromRequest } from '../lib/session';\n\nconst client = new DynamoDBClient({});\nexport const docClient = DynamoDBDocumentClient.from(client);\n\nexport type Handler = (event: APIGatewayProxyEventV2) => Promise<APIGatewayProxyResultV2>;\n\nexport function jsonResponse(statusCode: number, body: unknown): APIGatewayProxyResultV2 {\n  return {\n    statusCode,\n    headers: { 'content-type': 'application/json' },\n    body: JSON.stringify(body),\n  };\n}\n\nexport function notImplemented(resource: string, method: string) {\n  return jsonResponse(501, { ok: false, message: `${method} ${resource} not implemented` });\n}\n\nexport function badRequest(message: string) {\n  return jsonResponse(400, { ok: false, message });\n}\n\nexport function ok(body: unknown) {\n  return jsonResponse(200, body);\n}\n\nexport function getSession(event: APIGatewayProxyEventV2): SessionContext | null {\n  const parsed = parseSessionFromRequest(event);\n  if (parsed) return parsed;\n  // Fallback for temporary header-based dev mode\n  const agencyId = event.headers['x-agency-id'] || event.headers['X-Agency-Id'];\n  const agencyEmail = event.headers['x-agency-email'] || event.headers['X-Agency-Email'];\n  const role = (event.headers['x-role'] as SessionContext['role']) || 'agency';\n  if (!agencyId) return null;\n  return { agencyId, agencyEmail, role };\n}\n\nexport function requireSession(event: APIGatewayProxyEventV2): SessionContext | null {\n  return getSession(event);\n}\n\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;AACA;AACA;AAAA;AAEA;;;;AAEA,MAAM,SAAS,IAAI,sNAAc,CAAC,CAAC;AAC5B,MAAM,YAAY,mNAAsB,CAAC,IAAI,CAAC;AAI9C,SAAS,aAAa,UAAkB,EAAE,IAAa;IAC5D,OAAO;QACL;QACA,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;IACvB;AACF;AAEO,SAAS,eAAe,QAAgB,EAAE,MAAc;IAC7D,OAAO,aAAa,KAAK;QAAE,IAAI;QAAO,SAAS,GAAG,OAAO,CAAC,EAAE,SAAS,gBAAgB,CAAC;IAAC;AACzF;AAEO,SAAS,WAAW,OAAe;IACxC,OAAO,aAAa,KAAK;QAAE,IAAI;QAAO;IAAQ;AAChD;AAEO,SAAS,GAAG,IAAa;IAC9B,OAAO,aAAa,KAAK;AAC3B;AAEO,SAAS,WAAW,KAA6B;IACtD,MAAM,SAAS,IAAA,2JAAuB,EAAC;IACvC,IAAI,QAAQ,OAAO;IACnB,+CAA+C;IAC/C,MAAM,WAAW,MAAM,OAAO,CAAC,cAAc,IAAI,MAAM,OAAO,CAAC,cAAc;IAC7E,MAAM,cAAc,MAAM,OAAO,CAAC,iBAAiB,IAAI,MAAM,OAAO,CAAC,iBAAiB;IACtF,MAAM,OAAO,AAAC,MAAM,OAAO,CAAC,SAAS,IAA+B;IACpE,IAAI,CAAC,UAAU,OAAO;IACtB,OAAO;QAAE;QAAU;QAAa;IAAK;AACvC;AAEO,SAAS,eAAe,KAA6B;IAC1D,OAAO,WAAW;AACpB"}},
    {"offset": {"line": 293, "column": 0}, "map": {"version":3,"sources":["file:///Users/mrjames/Desktop/athletenarrative/web/web-app/infra/src/lib/dynamo.ts"],"sourcesContent":["import { GetCommand, PutCommand, QueryCommand, UpdateCommand, DeleteCommand } from '@aws-sdk/lib-dynamodb';\nimport { docClient } from '../handlers/common';\n\nconst TABLE_NAME = process.env.TABLE_NAME || 'agency-narrative-crm';\n\nexport async function putItem(item: Record<string, unknown>) {\n  await docClient.send(new PutCommand({ TableName: TABLE_NAME, Item: item }));\n  return item;\n}\n\nexport async function getItem(key: { PK: string; SK: string }) {\n  const res = await docClient.send(new GetCommand({ TableName: TABLE_NAME, Key: key }));\n  return res.Item;\n}\n\nexport async function queryByPK(PK: string, beginsWith?: string) {\n  const res = await docClient.send(\n    new QueryCommand({\n      TableName: TABLE_NAME,\n      KeyConditionExpression: beginsWith ? 'PK = :pk AND begins_with(SK, :sk)' : 'PK = :pk',\n      ExpressionAttributeValues: beginsWith ? { ':pk': PK, ':sk': beginsWith } : { ':pk': PK },\n    }),\n  );\n  return res.Items ?? [];\n}\n\nexport async function queryGSI1(GSI1PK: string, beginsWith?: string) {\n  const res = await docClient.send(\n    new QueryCommand({\n      TableName: TABLE_NAME,\n      IndexName: 'GSI1',\n      KeyConditionExpression: beginsWith ? 'GSI1PK = :g1pk AND begins_with(GSI1SK, :g1sk)' : 'GSI1PK = :g1pk',\n      ExpressionAttributeValues: beginsWith ? { ':g1pk': GSI1PK, ':g1sk': beginsWith } : { ':g1pk': GSI1PK },\n    }),\n  );\n  return res.Items ?? [];\n}\n\nexport async function updateItem(params: {\n  key: { PK: string; SK: string };\n  updateExpression: string;\n  expressionAttributeValues: Record<string, unknown>;\n  expressionAttributeNames?: Record<string, string>;\n}) {\n  const res = await docClient.send(\n    new UpdateCommand({\n      TableName: TABLE_NAME,\n      Key: params.key,\n      UpdateExpression: params.updateExpression,\n      ExpressionAttributeValues: params.expressionAttributeValues,\n      ExpressionAttributeNames: params.expressionAttributeNames,\n      ReturnValues: 'ALL_NEW',\n    }),\n  );\n  return res.Attributes;\n}\n\nexport async function deleteItem(key: { PK: string; SK: string }) {\n  await docClient.send(new DeleteCommand({ TableName: TABLE_NAME, Key: key }));\n}\n\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AACA;;;AAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU,IAAI;AAEtC,eAAe,QAAQ,IAA6B;IACzD,MAAM,iJAAS,CAAC,IAAI,CAAC,IAAI,uMAAU,CAAC;QAAE,WAAW;QAAY,MAAM;IAAK;IACxE,OAAO;AACT;AAEO,eAAe,QAAQ,GAA+B;IAC3D,MAAM,MAAM,MAAM,iJAAS,CAAC,IAAI,CAAC,IAAI,uMAAU,CAAC;QAAE,WAAW;QAAY,KAAK;IAAI;IAClF,OAAO,IAAI,IAAI;AACjB;AAEO,eAAe,UAAU,EAAU,EAAE,UAAmB;IAC7D,MAAM,MAAM,MAAM,iJAAS,CAAC,IAAI,CAC9B,IAAI,2MAAY,CAAC;QACf,WAAW;QACX,wBAAwB,aAAa,sCAAsC;QAC3E,2BAA2B,aAAa;YAAE,OAAO;YAAI,OAAO;QAAW,IAAI;YAAE,OAAO;QAAG;IACzF;IAEF,OAAO,IAAI,KAAK,IAAI,EAAE;AACxB;AAEO,eAAe,UAAU,MAAc,EAAE,UAAmB;IACjE,MAAM,MAAM,MAAM,iJAAS,CAAC,IAAI,CAC9B,IAAI,2MAAY,CAAC;QACf,WAAW;QACX,WAAW;QACX,wBAAwB,aAAa,kDAAkD;QACvF,2BAA2B,aAAa;YAAE,SAAS;YAAQ,SAAS;QAAW,IAAI;YAAE,SAAS;QAAO;IACvG;IAEF,OAAO,IAAI,KAAK,IAAI,EAAE;AACxB;AAEO,eAAe,WAAW,MAKhC;IACC,MAAM,MAAM,MAAM,iJAAS,CAAC,IAAI,CAC9B,IAAI,6MAAa,CAAC;QAChB,WAAW;QACX,KAAK,OAAO,GAAG;QACf,kBAAkB,OAAO,gBAAgB;QACzC,2BAA2B,OAAO,yBAAyB;QAC3D,0BAA0B,OAAO,wBAAwB;QACzD,cAAc;IAChB;IAEF,OAAO,IAAI,UAAU;AACvB;AAEO,eAAe,WAAW,GAA+B;IAC9D,MAAM,iJAAS,CAAC,IAAI,CAAC,IAAI,6MAAa,CAAC;QAAE,WAAW;QAAY,KAAK;IAAI;AAC3E"}},
    {"offset": {"line": 379, "column": 0}, "map": {"version":3,"sources":["file:///Users/mrjames/Desktop/athletenarrative/web/web-app/infra-adapter/dynamo.ts"],"sourcesContent":["export { putItem, getItem, queryByPK, queryGSI1, updateItem, deleteItem } from '../infra/src/lib/dynamo';\n\n\n"],"names":[],"mappings":";AAAA"}},
    {"offset": {"line": 386, "column": 0}, "map": {"version":3,"sources":["file:///Users/mrjames/Desktop/athletenarrative/web/web-app/app/api/forms/agency/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { verify } from '../../forms/token';\nimport { queryGSI1 } from '@/infra-adapter/dynamo';\n\nexport async function GET(req: NextRequest) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const token = (searchParams.get('token') || '').trim();\n    const payload = verify<{ agencyEmail: string; exp?: number }>(token || '');\n    if (!payload?.agencyEmail) {\n      return NextResponse.json({ ok: false, error: 'Invalid token' }, { status: 400 });\n    }\n    const byEmail = await queryGSI1(`EMAIL#${payload.agencyEmail}`, 'AGENCY#');\n    const agency = (byEmail || [])[0];\n    if (!agency) return NextResponse.json({ ok: false, error: 'Agency not found' }, { status: 404 });\n    return NextResponse.json({\n      ok: true,\n      agency: {\n        name: agency.name,\n        email: agency.email,\n        settings: agency.settings || {},\n      },\n    });\n  } catch (e: any) {\n    return NextResponse.json({ ok: false, error: e?.message || 'Failed to resolve agency' }, { status: 500 });\n  }\n}\n\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AAAA;;;;AAEO,eAAe,IAAI,GAAgB;IACxC,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;QACxC,MAAM,QAAQ,CAAC,aAAa,GAAG,CAAC,YAAY,EAAE,EAAE,IAAI;QACpD,MAAM,UAAU,IAAA,wIAAM,EAAwC,SAAS;QACvE,IAAI,CAAC,SAAS,aAAa;YACzB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,IAAI;gBAAO,OAAO;YAAgB,GAAG;gBAAE,QAAQ;YAAI;QAChF;QACA,MAAM,UAAU,MAAM,IAAA,4IAAS,EAAC,CAAC,MAAM,EAAE,QAAQ,WAAW,EAAE,EAAE;QAChE,MAAM,SAAS,CAAC,WAAW,EAAE,CAAC,CAAC,EAAE;QACjC,IAAI,CAAC,QAAQ,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO;QAAmB,GAAG;YAAE,QAAQ;QAAI;QAC9F,OAAO,gJAAY,CAAC,IAAI,CAAC;YACvB,IAAI;YACJ,QAAQ;gBACN,MAAM,OAAO,IAAI;gBACjB,OAAO,OAAO,KAAK;gBACnB,UAAU,OAAO,QAAQ,IAAI,CAAC;YAChC;QACF;IACF,EAAE,OAAO,GAAQ;QACf,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAO,OAAO,GAAG,WAAW;QAA2B,GAAG;YAAE,QAAQ;QAAI;IACzG;AACF"}}]
}