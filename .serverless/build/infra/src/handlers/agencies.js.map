{
  "version": 3,
  "sources": ["../../../../../infra/src/handlers/agencies.ts", "../../../../../infra/src/handlers/cors.ts", "../../../../../infra/src/lib/dynamo.ts", "../../../../../infra/src/handlers/common.ts", "../../../../../infra/src/lib/session.ts", "../../../../../infra/src/lib/ids.ts"],
  "sourcesContent": ["import { APIGatewayProxyEventV2 } from 'aws-lambda';\nimport { response } from './cors';\nimport { getItem, putItem, queryGSI1 } from '../lib/dynamo';\nimport { newId } from '../lib/ids';\n\ntype AgencyRecord = {\n  PK: string;\n  SK: string;\n  GSI1PK: string;\n  GSI1SK: string;\n  id: string;\n  name: string;\n  email: string;\n  settings?: { primaryColor?: string; secondaryColor?: string; logoDataUrl?: string };\n  deletedAt?: string;\n};\n\nfunction toRecord(input: { id?: string; name?: string; email?: string; settings?: any }): AgencyRecord {\n  const id = input.id || newId('agency');\n  return {\n    PK: `AGENCY#${id}`,\n    SK: 'PROFILE',\n    GSI1PK: `EMAIL#${input.email}`,\n    GSI1SK: `AGENCY#${id}`,\n    id,\n    name: input.name || 'New Agency',\n    email: input.email || '',\n    settings: input.settings,\n  };\n}\n\nexport const handler = async (event: APIGatewayProxyEventV2) => {\n  const origin = event.headers?.origin || event.headers?.Origin || event.headers?.['origin'] || '';\n  const method = (event.requestContext.http?.method || '').toUpperCase();\n  if (!method) return response(400, { ok: false, error: 'Missing method' }, origin);\n\n  console.log('agencies handler start', { method, path: event.rawPath, qs: event.queryStringParameters });\n\n  try {\n    if (method === 'OPTIONS') return response(200, { ok: true }, origin);\n\n    if (method === 'GET') {\n      const email = event.queryStringParameters?.email;\n      if (email) {\n        const found = await queryGSI1(`EMAIL#${email}`, 'AGENCY#');\n        return response(200, { ok: true, agencies: found || [] }, origin);\n      }\n      // No email filter: avoid table scan; return empty list\n      return response(200, { ok: true, agencies: [] }, origin);\n    }\n\n    if (method === 'PUT' && event.rawPath?.endsWith('/agencies/settings')) {\n      if (!event.body) return response(400, { ok: false, error: 'Missing body' }, origin);\n      const parsed = JSON.parse(event.body || '{}');\n      const email = parsed.email;\n      if (!email) return response(400, { ok: false, error: 'Missing email' }, origin);\n      const existing = await queryGSI1(`EMAIL#${email}`, 'AGENCY#');\n      const agency = existing?.[0];\n      if (!agency) return response(404, { ok: false, error: 'Agency not found' }, origin);\n      const updated = { ...agency, settings: parsed.settings || {} };\n      await putItem(updated);\n      console.log('agencies update settings', { email, settings: updated.settings });\n      return response(200, { ok: true, settings: updated.settings }, origin);\n    }\n\n    if (method === 'POST') {\n      console.log('agencies POST start', { rawBody: event.body });\n      const body = event.body ? JSON.parse(event.body) : {};\n      if (!body.email || !body.name) {\n        console.warn('agencies POST missing fields', { body });\n        return response(400, { ok: false, error: 'name and email are required' }, origin);\n      }\n      const rec = toRecord(body);\n      try {\n        await putItem(rec);\n        console.log('agencies upsert success', { id: rec.id, email: rec.email, settings: rec.settings });\n        return response(200, { ok: true, id: rec.id }, origin);\n      } catch (err: any) {\n        console.error('agencies upsert error', { error: err?.message, stack: err?.stack, id: rec.id, email: rec.email });\n        return response(500, { ok: false, error: err?.message || 'Failed to upsert agency' }, origin);\n      }\n    }\n\n    if (method === 'DELETE') {\n      const id = event.queryStringParameters?.id;\n      if (!id) return response(400, { ok: false, error: 'Missing id' }, origin);\n      const existing = await getItem({ PK: `AGENCY#${id}`, SK: 'PROFILE' });\n      if (!existing) return response(404, { ok: false, error: 'Not found' }, origin);\n      await putItem({ ...existing, deletedAt: new Date().toISOString() });\n      console.log('agencies soft-deleted', { id });\n      return response(200, { ok: true }, origin);\n    }\n\n    return response(405, { ok: false, error: `Method not allowed` }, origin);\n  } catch (e: any) {\n    console.error('agencies handler error', { error: e?.message, stack: e?.stack });\n    return response(500, { ok: false, error: e?.message || 'Server error' }, origin);\n  }\n};\n\n", "export const ALLOWED_ORIGINS = [\n  'https://master.d2yp6hyv6u0efd.amplifyapp.com',\n  'https://myrecruiteragency.com',\n  'https://www.myrecruiteragency.com',\n  'http://localhost:3000',\n  'http://localhost:3001',\n];\n\nexport function buildCors(origin?: string) {\n  const allow = origin && ALLOWED_ORIGINS.includes(origin) ? origin : ALLOWED_ORIGINS[0];\n  return {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': allow,\n    'Access-Control-Allow-Credentials': 'true',\n    'Access-Control-Allow-Headers': 'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token',\n    'Access-Control-Allow-Methods': 'GET,POST,PUT,PATCH,DELETE,OPTIONS',\n  };\n}\n\nexport function response(statusCode: number, body: unknown, origin?: string, extraHeaders?: Record<string, string>) {\n  const cors = buildCors(origin);\n  return {\n    statusCode,\n    headers: { ...cors, ...(extraHeaders || {}) },\n    body: JSON.stringify(body),\n  };\n}\n\n", "import { GetCommand, PutCommand, QueryCommand, UpdateCommand, DeleteCommand } from '@aws-sdk/lib-dynamodb';\nimport { docClient } from '../handlers/common';\n\nconst TABLE_NAME = process.env.TABLE_NAME || 'agency-narrative-crm';\n\nexport async function putItem(item: Record<string, unknown>) {\n  await docClient.send(new PutCommand({ TableName: TABLE_NAME, Item: item }));\n  return item;\n}\n\nexport async function getItem(key: { PK: string; SK: string }) {\n  const res = await docClient.send(new GetCommand({ TableName: TABLE_NAME, Key: key }));\n  return res.Item;\n}\n\nexport async function queryByPK(PK: string, beginsWith?: string) {\n  const res = await docClient.send(\n    new QueryCommand({\n      TableName: TABLE_NAME,\n      KeyConditionExpression: beginsWith ? 'PK = :pk AND begins_with(SK, :sk)' : 'PK = :pk',\n      ExpressionAttributeValues: beginsWith ? { ':pk': PK, ':sk': beginsWith } : { ':pk': PK },\n    }),\n  );\n  return res.Items ?? [];\n}\n\nexport async function queryGSI1(GSI1PK: string, beginsWith?: string) {\n  const res = await docClient.send(\n    new QueryCommand({\n      TableName: TABLE_NAME,\n      IndexName: 'GSI1',\n      KeyConditionExpression: beginsWith ? 'GSI1PK = :g1pk AND begins_with(GSI1SK, :g1sk)' : 'GSI1PK = :g1pk',\n      ExpressionAttributeValues: beginsWith ? { ':g1pk': GSI1PK, ':g1sk': beginsWith } : { ':g1pk': GSI1PK },\n    }),\n  );\n  return res.Items ?? [];\n}\n\nexport async function updateItem(params: {\n  key: { PK: string; SK: string };\n  updateExpression: string;\n  expressionAttributeValues: Record<string, unknown>;\n  expressionAttributeNames?: Record<string, string>;\n}) {\n  const res = await docClient.send(\n    new UpdateCommand({\n      TableName: TABLE_NAME,\n      Key: params.key,\n      UpdateExpression: params.updateExpression,\n      ExpressionAttributeValues: params.expressionAttributeValues,\n      ExpressionAttributeNames: params.expressionAttributeNames,\n      ReturnValues: 'ALL_NEW',\n    }),\n  );\n  return res.Attributes;\n}\n\nexport async function deleteItem(key: { PK: string; SK: string }) {\n  await docClient.send(new DeleteCommand({ TableName: TABLE_NAME, Key: key }));\n}\n\n", "import { APIGatewayProxyEventV2, APIGatewayProxyResultV2 } from 'aws-lambda';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient } from '@aws-sdk/lib-dynamodb';\nimport { SessionContext } from '../lib/models';\nimport { parseSessionFromRequest } from '../lib/session';\n\nconst client = new DynamoDBClient({});\nexport const docClient = DynamoDBDocumentClient.from(client);\n\nexport type Handler = (event: APIGatewayProxyEventV2) => Promise<APIGatewayProxyResultV2>;\n\nexport function jsonResponse(statusCode: number, body: unknown): APIGatewayProxyResultV2 {\n  return {\n    statusCode,\n    headers: { 'content-type': 'application/json' },\n    body: JSON.stringify(body),\n  };\n}\n\nexport function notImplemented(resource: string, method: string) {\n  return jsonResponse(501, { ok: false, message: `${method} ${resource} not implemented` });\n}\n\nexport function badRequest(message: string) {\n  return jsonResponse(400, { ok: false, message });\n}\n\nexport function ok(body: unknown) {\n  return jsonResponse(200, body);\n}\n\nexport function getSession(event: APIGatewayProxyEventV2): SessionContext | null {\n  const parsed = parseSessionFromRequest(event);\n  if (parsed) return parsed;\n  // Fallback for temporary header-based dev mode\n  const agencyId = event.headers['x-agency-id'] || event.headers['X-Agency-Id'];\n  const agencyEmail = event.headers['x-agency-email'] || event.headers['X-Agency-Email'];\n  const role = (event.headers['x-role'] as SessionContext['role']) || 'agency';\n  if (!agencyId) return null;\n  return { agencyId, agencyEmail, role };\n}\n\nexport function requireSession(event: APIGatewayProxyEventV2): SessionContext | null {\n  return getSession(event);\n}\n\n", "import { APIGatewayProxyEventV2 } from 'aws-lambda';\nimport { createHmac, timingSafeEqual } from 'crypto';\nimport { SessionContext } from './models';\n\nconst SECRET = process.env.SESSION_SECRET || 'dev-secret-change-me';\nconst COOKIE_NAME = 'an_session';\n\nfunction sign(payload: string) {\n  const sig = createHmac('sha256', SECRET).update(payload).digest('base64url');\n  return `${payload}.${sig}`;\n}\n\nfunction verify(token: string) {\n  const idx = token.lastIndexOf('.');\n  if (idx < 0) return null;\n  const payload = token.slice(0, idx);\n  const sig = token.slice(idx + 1);\n  const expected = createHmac('sha256', SECRET).update(payload).digest('base64url');\n  const a = Buffer.from(sig);\n  const b = Buffer.from(expected);\n  if (a.length !== b.length || !timingSafeEqual(a, b)) return null;\n  try {\n    return JSON.parse(Buffer.from(payload, 'base64url').toString('utf8')) as SessionContext;\n  } catch {\n    return null;\n  }\n}\n\nexport function encodeSession(session: SessionContext) {\n  const payload = Buffer.from(JSON.stringify(session)).toString('base64url');\n  return sign(payload);\n}\n\nexport function parseSession(token?: string | null): SessionContext | null {\n  if (!token) return null;\n  return verify(token);\n}\n\nfunction parseCookie(header?: string): Record<string, string> {\n  if (!header) return {};\n  return header.split(';').reduce<Record<string, string>>((acc, part) => {\n    const [k, v] = part.trim().split('=');\n    if (k && v) acc[k] = v;\n    return acc;\n  }, {});\n}\n\nexport function parseSessionFromRequest(event: APIGatewayProxyEventV2): SessionContext | null {\n  const cookieHeader = event.headers.cookie || event.headers.Cookie;\n  const cookies = parseCookie(cookieHeader);\n  const token = cookies[COOKIE_NAME];\n  return parseSession(token);\n}\n\nexport function buildSessionCookie(token: string, secure = true) {\n  const attrs = [\n    `${COOKIE_NAME}=${token}`,\n    'HttpOnly',\n    'Path=/',\n    'SameSite=None',\n    ...(secure ? ['Secure'] : []),\n    'Max-Age=604800', // 7d\n  ];\n  return attrs.join('; ');\n}\n\nexport function buildClearCookie(secure = true) {\n  const attrs = [`${COOKIE_NAME}=; Path=/; Max-Age=0; HttpOnly; SameSite=None${secure ? '; Secure' : ''}`];\n  return attrs.join('; ');\n}\n\n", "export function newId(prefix: string) {\n  const rand = globalThis.crypto?.randomUUID?.() ?? `${Date.now()}-${Math.random().toString(36).slice(2, 10)}`;\n  return `${prefix}-${rand}`.replace(/[^a-zA-Z0-9-_]/g, '');\n}\n\n"],
  "mappings": "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",
  "names": ["import_lib_dynamodb"]
}
