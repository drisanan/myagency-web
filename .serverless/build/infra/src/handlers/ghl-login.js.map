{
  "version": 3,
  "sources": ["../../../../../infra/src/handlers/ghl-login.ts"],
  "sourcesContent": ["import { APIGatewayProxyEventV2, APIGatewayProxyResultV2 } from 'aws-lambda';\n\nconst bearerToken =\n  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJsb2NhdGlvbl9pZCI6IjZCSXRESEVyQTRTVllyUDgxVk1DIiwiY29tcGFueV9pZCI6IjFVbGN6NWpEUjY1N0hwUEFIU0VyIiwidmVyc2lvbiI6MSwiaWF0IjoxNzAyNTAwMjk3Njg4LCJzdWIiOiJ1c2VyX2lkIn0.fqrY7YeSxhmjWhgXySUrWTYvlZwfjjXCP9o8mTZ8exU';\nconst accessCodeFieldId = 'D3ogBTF9YTkxJybeMVvF';\nconst agencyIdFieldId = '2nUnTxRCuWPiGQ4j23we';\nconst agencyNameFieldId = 'mSth0jJ8VQk1k9caFxCC';\nconst agencyColorFieldId = '0STRDPbWyZ6ChSApAtjz';\nconst agencyLogoFieldId = 'Bvng0E2Yf5TkmEI8KyD6';\nconst ALLOWED_ORIGINS = [\n  'https://master.d2yp6hyv6u0efd.amplifyapp.com',\n  'http://localhost:3001',\n  'http://localhost:3000',\n];\n\nfunction getHeaders(origin?: string) {\n  const allowOrigin = origin && ALLOWED_ORIGINS.includes(origin) ? origin : ALLOWED_ORIGINS[0];\n  return {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': allowOrigin,\n    'Access-Control-Allow-Credentials': 'true',\n    'Access-Control-Allow-Headers': 'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token',\n    'Access-Control-Allow-Methods': 'POST,OPTIONS',\n  };\n}\n\nexport const handler = async (event: APIGatewayProxyEventV2): Promise<APIGatewayProxyResultV2> => {\n  const origin = event.headers?.origin || event.headers?.Origin || event.headers?.['origin'] || '';\n  const headers = getHeaders(origin);\n  const method = (event.requestContext.http?.method || '').toUpperCase();\n\n  if (method === 'OPTIONS') {\n    return { statusCode: 200, headers, body: JSON.stringify({ ok: true }) };\n  }\n\n  if (method !== 'POST') {\n    return { statusCode: 405, headers, body: JSON.stringify({ ok: false, error: `Method not allowed` }) };\n  }\n\n  try {\n    if (!event.body) {\n      return { statusCode: 400, headers, body: JSON.stringify({ ok: false, error: 'Missing body' }) };\n    }\n\n    const { email, phone, accessCode } = JSON.parse(event.body);\n    if (!email || !phone || !accessCode) {\n      return { statusCode: 400, headers, body: JSON.stringify({ ok: false, error: 'Missing credentials' }) };\n    }\n\n    const emailTrim = String(email).trim();\n    const phoneTrim = String(phone).trim();\n    const accessCodeInput = String(accessCode).trim();\n\n    if (!/^\\+?\\d+$/.test(phoneTrim)) {\n      return { statusCode: 400, headers, body: JSON.stringify({ ok: false, error: 'Invalid phone' }) };\n    }\n    if (!/^\\d+$/.test(accessCodeInput)) {\n      return { statusCode: 400, headers, body: JSON.stringify({ ok: false, error: 'Invalid access code format' }) };\n    }\n\n    const encodedEmail = encodeURIComponent(emailTrim);\n    const encodedPhone = encodeURIComponent(phoneTrim);\n    const apiUrl = `https://rest.gohighlevel.com/v1/contacts/lookup?email=${encodedEmail}&phone=${encodedPhone}`;\n\n    const res = await fetch(apiUrl, {\n      headers: {\n        Authorization: `Bearer ${bearerToken}`,\n        'Content-Type': 'application/json',\n      },\n      cache: 'no-store',\n    });\n\n    const data = await res.json();\n    if (!res.ok) {\n      const errMsg = data?.message || 'Lookup failed';\n      return { statusCode: res.status, headers, body: JSON.stringify({ ok: false, error: errMsg }) };\n    }\n\n    const contact = data?.contacts?.[0];\n    if (!contact) {\n      return { statusCode: 404, headers, body: JSON.stringify({ ok: false, error: 'Contact not found' }) };\n    }\n    \n    const customFields = contact.customField || [];\n    const accessField = customFields.find((f: any) => f.id === accessCodeFieldId);\n    const storedAccessCode = accessField?.value;\n    const storedAccessCodeStr = storedAccessCode == null ? '' : String(storedAccessCode).trim();\n\n    if (!storedAccessCodeStr || storedAccessCodeStr !== accessCodeInput) {\n      return { statusCode: 401, headers, body: JSON.stringify({ ok: false, error: 'Invalid access code' }) };\n    }\n\n    const agencyId = (customFields.find((f: any) => f.id === agencyIdFieldId)?.value || '').toString().trim();\n    const agencyName = (customFields.find((f: any) => f.id === agencyNameFieldId)?.value || '').toString().trim();\n    const agencyColor = (customFields.find((f: any) => f.id === agencyColorFieldId)?.value || '').toString().trim();\n    const agencyLogo = (customFields.find((f: any) => f.id === agencyLogoFieldId)?.value || '').toString().trim();\n    const isNew = agencyId === 'READY';\n\n    return {\n      statusCode: 200,\n      headers,\n      body: JSON.stringify({\n        ok: true,\n        contact: {\n          id: contact.id,\n          email: contact.email,\n          firstName: contact.firstName,\n          lastName: contact.lastName,\n          phone: contact.phone,\n          accessCode: storedAccessCode,\n        },\n        agency: {\n          id: agencyId || undefined,\n          name: agencyName || undefined,\n          color: agencyColor || undefined,\n          logoUrl: agencyLogo || undefined,\n          isNew,\n        },\n      }),\n    };\n  } catch (e: any) {\n    console.error('ghl-login lambda error', e);\n    return {\n      statusCode: 500,\n      headers,\n      body: JSON.stringify({ ok: false, error: e?.message || 'Server error' }),\n    };\n  }\n};\n\n"],
  "mappings": "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",
  "names": []
}
