{
  "version": 3,
  "sources": ["../../../../../infra/src/handlers/auth.ts", "../../../../../infra/src/handlers/common.ts", "../../../../../infra/src/lib/session.ts"],
  "sourcesContent": ["import { APIGatewayProxyEventV2 } from 'aws-lambda';\nimport { Handler, badRequest, ok } from './common';\nimport { buildClearCookie, buildSessionCookie, encodeSession, parseSessionFromRequest } from '../lib/session';\n\nexport const handler: Handler = async (event: APIGatewayProxyEventV2) => {\n  if (!event.requestContext.http?.method) {\n    return badRequest('Missing method');\n  }\n  const method = event.requestContext.http.method.toUpperCase();\n  const originHdr = event.headers['origin'] || event.headers['Origin'] || '';\n  const host = event.headers['x-forwarded-host'] || event.headers['Host'] || '';\n  const proto = event.headers['x-forwarded-proto'] || 'https';\n  const resolvedOrigin = originHdr || `${proto}://${host}`;\n  const secureCookie = proto === 'https' && !resolvedOrigin.includes('localhost');\n\n  const corsHeaders = {\n    'access-control-allow-origin': resolvedOrigin,\n    'access-control-allow-credentials': 'true',\n    'access-control-allow-headers': 'Content-Type,Authorization',\n    'access-control-allow-methods': 'GET,POST,DELETE,OPTIONS',\n  };\n\n  if (method === 'OPTIONS') {\n    return { statusCode: 200, headers: corsHeaders, body: JSON.stringify({ ok: true }) };\n  }\n\n  switch (method) {\n    case 'GET':\n      return {\n        statusCode: 200,\n        headers: { ...corsHeaders, 'content-type': 'application/json' },\n        body: JSON.stringify({ ok: true, session: parseSessionFromRequest(event) }),\n      };\n    case 'POST':\n      if (!event.body) return badRequest('Missing body');\n      const payload = JSON.parse(event.body);\n      if (!payload.agencyId || !payload.email || !payload.role) {\n        return badRequest('agencyId, email, role required');\n      }\n      const token = encodeSession({\n        agencyId: payload.agencyId,\n        agencyEmail: payload.email,\n        role: payload.role,\n        userId: payload.userId,\n      });\n      const cookie = buildSessionCookie(token, secureCookie);\n      return {\n        statusCode: 200,\n        headers: { ...corsHeaders, 'content-type': 'application/json', 'set-cookie': cookie },\n        body: JSON.stringify({ ok: true, session: payload }),\n      };\n    case 'DELETE':\n      return {\n        statusCode: 200,\n        headers: { ...corsHeaders, 'set-cookie': buildClearCookie(secureCookie) },\n        body: JSON.stringify({ ok: true }),\n      };\n    default:\n      return badRequest(`Unsupported method ${method}`);\n  }\n};\n\n", "import { APIGatewayProxyEventV2, APIGatewayProxyResultV2 } from 'aws-lambda';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient } from '@aws-sdk/lib-dynamodb';\nimport { SessionContext } from '../lib/models';\nimport { parseSessionFromRequest } from '../lib/session';\n\nconst client = new DynamoDBClient({});\nexport const docClient = DynamoDBDocumentClient.from(client);\n\nexport type Handler = (event: APIGatewayProxyEventV2) => Promise<APIGatewayProxyResultV2>;\n\nexport function jsonResponse(statusCode: number, body: unknown): APIGatewayProxyResultV2 {\n  return {\n    statusCode,\n    headers: { 'content-type': 'application/json' },\n    body: JSON.stringify(body),\n  };\n}\n\nexport function notImplemented(resource: string, method: string) {\n  return jsonResponse(501, { ok: false, message: `${method} ${resource} not implemented` });\n}\n\nexport function badRequest(message: string) {\n  return jsonResponse(400, { ok: false, message });\n}\n\nexport function ok(body: unknown) {\n  return jsonResponse(200, body);\n}\n\nexport function getSession(event: APIGatewayProxyEventV2): SessionContext | null {\n  const parsed = parseSessionFromRequest(event);\n  if (parsed) return parsed;\n  // Fallback for temporary header-based dev mode\n  const agencyId = event.headers['x-agency-id'] || event.headers['X-Agency-Id'];\n  const agencyEmail = event.headers['x-agency-email'] || event.headers['X-Agency-Email'];\n  const role = (event.headers['x-role'] as SessionContext['role']) || 'agency';\n  if (!agencyId) return null;\n  return { agencyId, agencyEmail, role };\n}\n\nexport function requireSession(event: APIGatewayProxyEventV2): SessionContext | null {\n  return getSession(event);\n}\n\n", "import { APIGatewayProxyEventV2 } from 'aws-lambda';\nimport { createHmac, timingSafeEqual } from 'crypto';\nimport { SessionContext } from './models';\n\nconst SECRET = process.env.SESSION_SECRET || 'dev-secret-change-me';\nconst COOKIE_NAME = 'an_session';\n\nfunction sign(payload: string) {\n  const sig = createHmac('sha256', SECRET).update(payload).digest('base64url');\n  return `${payload}.${sig}`;\n}\n\nfunction verify(token: string) {\n  const idx = token.lastIndexOf('.');\n  if (idx < 0) return null;\n  const payload = token.slice(0, idx);\n  const sig = token.slice(idx + 1);\n  const expected = createHmac('sha256', SECRET).update(payload).digest('base64url');\n  const a = Buffer.from(sig);\n  const b = Buffer.from(expected);\n  if (a.length !== b.length || !timingSafeEqual(a, b)) return null;\n  try {\n    return JSON.parse(Buffer.from(payload, 'base64url').toString('utf8')) as SessionContext;\n  } catch {\n    return null;\n  }\n}\n\nexport function encodeSession(session: SessionContext) {\n  const payload = Buffer.from(JSON.stringify(session)).toString('base64url');\n  return sign(payload);\n}\n\nexport function parseSession(token?: string | null): SessionContext | null {\n  if (!token) return null;\n  return verify(token);\n}\n\nfunction parseCookie(header?: string): Record<string, string> {\n  if (!header) return {};\n  return header.split(';').reduce<Record<string, string>>((acc, part) => {\n    const [k, v] = part.trim().split('=');\n    if (k && v) acc[k] = v;\n    return acc;\n  }, {});\n}\n\nexport function parseSessionFromRequest(event: APIGatewayProxyEventV2): SessionContext | null {\n  const cookieHeader = event.headers.cookie || event.headers.Cookie;\n  const cookies = parseCookie(cookieHeader);\n  const token = cookies[COOKIE_NAME];\n  return parseSession(token);\n}\n\nexport function buildSessionCookie(token: string, secure = true) {\n  const attrs = [\n    `${COOKIE_NAME}=${token}`,\n    'HttpOnly',\n    'Path=/',\n    'SameSite=Lax',\n    ...(secure ? ['Secure'] : []),\n    'Max-Age=604800', // 7d\n  ];\n  return attrs.join('; ');\n}\n\nexport function buildClearCookie(secure = true) {\n  const attrs = [`${COOKIE_NAME}=; Path=/; Max-Age=0; HttpOnly; SameSite=Lax${secure ? '; Secure' : ''}`];\n  return attrs.join('; ');\n}\n\n"],
  "mappings": "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",
  "names": []
}
