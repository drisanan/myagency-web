{
  "version": 3,
  "sources": ["../../../../../infra/src/handlers/auth.ts", "../../../../../infra/src/lib/session.ts", "../../../../../infra/src/handlers/cors.ts"],
  "sourcesContent": ["import { APIGatewayProxyEventV2 } from 'aws-lambda';\nimport { buildClearCookie, buildSessionCookie, encodeSession, parseSessionFromRequest } from '../lib/session';\nimport { response } from './cors';\n\nexport const handler = async (event: APIGatewayProxyEventV2) => {\n  const origin = event.headers?.origin || event.headers?.Origin || event.headers?.['origin'] || '';\n  const method = (event.requestContext.http?.method || '').toUpperCase();\n  if (!method) return response(400, { ok: false, error: 'Missing method' }, origin);\n\n  const host = event.headers['x-forwarded-host'] || event.headers['Host'] || '';\n  const proto = event.headers['x-forwarded-proto'] || 'https';\n  const resolvedOrigin = origin || `${proto}://${host}`;\n  const secureCookie = proto === 'https' && !resolvedOrigin.includes('localhost');\n\n  if (method === 'OPTIONS') {\n    return response(200, { ok: true }, origin);\n  }\n\n  if (method === 'GET') {\n    const cookieHeader = event.headers?.cookie || event.headers?.Cookie;\n    const session = parseSessionFromRequest(event);\n    console.log('auth GET', { origin, cookie: cookieHeader, session });\n    return response(200, { ok: true, session }, origin);\n  }\n\n  if (method === 'POST') {\n    if (!event.body) return response(400, { ok: false, error: 'Missing body' }, origin);\n    const payload = JSON.parse(event.body);\n    if (!payload.agencyId || !payload.email || !payload.role) {\n      return response(400, { ok: false, error: 'agencyId, email, role required' }, origin);\n    }\n    const token = encodeSession({\n      agencyId: payload.agencyId,\n      agencyEmail: payload.email,\n      role: payload.role,\n      userId: payload.userId,\n      firstName: payload.firstName,\n      lastName: payload.lastName,\n      agencyLogo: payload.agencyLogo,\n      agencySettings: payload.agencySettings,\n    });\n    const cookie = buildSessionCookie(token, secureCookie);\n    return response(200, { ok: true, session: payload }, origin, { 'set-cookie': cookie });\n  }\n\n  if (method === 'DELETE') {\n    return response(200, { ok: true }, origin, { 'set-cookie': buildClearCookie(secureCookie) });\n  }\n\n  return response(405, { ok: false, error: `Method not allowed` }, origin);\n};\n\n", "import { APIGatewayProxyEventV2 } from 'aws-lambda';\nimport { createHmac, timingSafeEqual } from 'crypto';\nimport { SessionContext } from './models';\n\nconst SECRET = process.env.SESSION_SECRET || 'dev-secret-change-me';\nconst COOKIE_NAME = 'an_session';\nconst COOKIE_DOMAIN = process.env.COOKIE_DOMAIN || '.myrecruiteragency.com';\n\nfunction sign(payload: string) {\n  const sig = createHmac('sha256', SECRET).update(payload).digest('base64url');\n  return `${payload}.${sig}`;\n}\n\nfunction verify(token: string) {\n  const idx = token.lastIndexOf('.');\n  if (idx < 0) return null;\n  const payload = token.slice(0, idx);\n  const sig = token.slice(idx + 1);\n  const expected = createHmac('sha256', SECRET).update(payload).digest('base64url');\n  const a = Buffer.from(sig);\n  const b = Buffer.from(expected);\n  if (a.length !== b.length || !timingSafeEqual(a, b)) return null;\n  try {\n    return JSON.parse(Buffer.from(payload, 'base64url').toString('utf8')) as SessionContext;\n  } catch {\n    return null;\n  }\n}\n\nexport function encodeSession(session: SessionContext) {\n  const payload = Buffer.from(JSON.stringify(session)).toString('base64url');\n  return sign(payload);\n}\n\nexport function parseSession(token?: string | null): SessionContext | null {\n  if (!token) return null;\n  return verify(token);\n}\n\nfunction parseCookie(header?: string): Record<string, string> {\n  if (!header) return {};\n  return header.split(';').reduce<Record<string, string>>((acc, part) => {\n    const [k, v] = part.trim().split('=');\n    if (k && v) acc[k] = v;\n    return acc;\n  }, {});\n}\n\nfunction readCookieString(event: APIGatewayProxyEventV2): string | undefined {\n  if (event.cookies && event.cookies.length > 0) {\n    return event.cookies.join('; ');\n  }\n  return event.headers.cookie || (event.headers as any).Cookie;\n}\n\nexport function parseSessionFromRequest(event: APIGatewayProxyEventV2): SessionContext | null {\n  const cookieHeader = readCookieString(event);\n  const cookies = parseCookie(cookieHeader);\n  const token = cookies[COOKIE_NAME];\n  return parseSession(token);\n}\n\nexport function buildSessionCookie(token: string, secure = true) {\n  const attrs = [\n    `${COOKIE_NAME}=${token}`,\n    'HttpOnly',\n    'Path=/',\n    'SameSite=None',\n    `Domain=${COOKIE_DOMAIN}`,\n    ...(secure ? ['Secure'] : []),\n    'Max-Age=604800', // 7d\n  ];\n  return attrs.join('; ');\n}\n\nexport function buildClearCookie(secure = true) {\n  const attrs = [\n    `${COOKIE_NAME}=; Path=/; Max-Age=0; HttpOnly; SameSite=None; Domain=${COOKIE_DOMAIN}${\n      secure ? '; Secure' : ''\n    }`,\n  ];\n  return attrs.join('; ');\n}\n\n", "export const ALLOWED_ORIGINS = [\n  'https://master.d2yp6hyv6u0efd.amplifyapp.com',\n  'https://myrecruiteragency.com',\n  'https://www.myrecruiteragency.com',\n  'http://localhost:3000',\n  'http://localhost:3001',\n];\n\nexport function buildCors(origin?: string) {\n  const allow = origin && ALLOWED_ORIGINS.includes(origin) ? origin : ALLOWED_ORIGINS[0];\n  return {\n    'Content-Type': 'application/json',\n    'Access-Control-Allow-Origin': allow,\n    'Access-Control-Allow-Credentials': 'true',\n    'Access-Control-Allow-Headers': 'Content-Type,Authorization,X-Amz-Date,X-Api-Key,X-Amz-Security-Token',\n    'Access-Control-Allow-Methods': 'GET,POST,PUT,PATCH,DELETE,OPTIONS',\n  };\n}\n\nexport function response(statusCode: number, body: unknown, origin?: string, extraHeaders?: Record<string, string>) {\n  const cors = buildCors(origin);\n  return {\n    statusCode,\n    headers: { ...cors, ...(extraHeaders || {}) },\n    body: JSON.stringify(body),\n  };\n}\n\n"],
  "mappings": "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",
  "names": []
}
