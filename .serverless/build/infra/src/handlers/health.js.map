{
  "version": 3,
  "sources": ["../../../../../infra/src/handlers/health.ts", "../../../../../infra/src/handlers/common.ts", "../../../../../infra/src/lib/session.ts"],
  "sourcesContent": ["import { Handler, ok } from './common';\n\nexport const handler: Handler = async () => {\n  return ok({ ok: true, service: 'athlete-narrative-api', status: 'healthy' });\n};\n\n", "import { APIGatewayProxyEventV2, APIGatewayProxyResultV2 } from 'aws-lambda';\nimport { DynamoDBClient } from '@aws-sdk/client-dynamodb';\nimport { DynamoDBDocumentClient } from '@aws-sdk/lib-dynamodb';\nimport { SessionContext } from '../lib/models';\nimport { parseSessionFromRequest } from '../lib/session';\n\nconst client = new DynamoDBClient({});\nexport const docClient = DynamoDBDocumentClient.from(client);\n\nexport type Handler = (event: APIGatewayProxyEventV2) => Promise<APIGatewayProxyResultV2>;\n\nexport function jsonResponse(statusCode: number, body: unknown): APIGatewayProxyResultV2 {\n  return {\n    statusCode,\n    headers: { 'content-type': 'application/json' },\n    body: JSON.stringify(body),\n  };\n}\n\nexport function notImplemented(resource: string, method: string) {\n  return jsonResponse(501, { ok: false, message: `${method} ${resource} not implemented` });\n}\n\nexport function badRequest(message: string) {\n  return jsonResponse(400, { ok: false, message });\n}\n\nexport function ok(body: unknown) {\n  return jsonResponse(200, body);\n}\n\nexport function getSession(event: APIGatewayProxyEventV2): SessionContext | null {\n  const parsed = parseSessionFromRequest(event);\n  if (parsed) return parsed;\n  // Fallback for temporary header-based dev mode\n  const agencyId = event.headers['x-agency-id'] || event.headers['X-Agency-Id'];\n  const agencyEmail = event.headers['x-agency-email'] || event.headers['X-Agency-Email'];\n  const role = (event.headers['x-role'] as SessionContext['role']) || 'agency';\n  if (!agencyId) return null;\n  return { agencyId, agencyEmail, role };\n}\n\nexport function requireSession(event: APIGatewayProxyEventV2): SessionContext | null {\n  return getSession(event);\n}\n\n", "import { APIGatewayProxyEventV2 } from 'aws-lambda';\nimport { createHmac, timingSafeEqual } from 'crypto';\nimport { SessionContext } from './models';\n\nconst SECRET = process.env.SESSION_SECRET || 'dev-secret-change-me';\nconst COOKIE_NAME = 'an_session';\n\nfunction sign(payload: string) {\n  const sig = createHmac('sha256', SECRET).update(payload).digest('base64url');\n  return `${payload}.${sig}`;\n}\n\nfunction verify(token: string) {\n  const idx = token.lastIndexOf('.');\n  if (idx < 0) return null;\n  const payload = token.slice(0, idx);\n  const sig = token.slice(idx + 1);\n  const expected = createHmac('sha256', SECRET).update(payload).digest('base64url');\n  const a = Buffer.from(sig);\n  const b = Buffer.from(expected);\n  if (a.length !== b.length || !timingSafeEqual(a, b)) return null;\n  try {\n    return JSON.parse(Buffer.from(payload, 'base64url').toString('utf8')) as SessionContext;\n  } catch {\n    return null;\n  }\n}\n\nexport function encodeSession(session: SessionContext) {\n  const payload = Buffer.from(JSON.stringify(session)).toString('base64url');\n  return sign(payload);\n}\n\nexport function parseSession(token?: string | null): SessionContext | null {\n  if (!token) return null;\n  return verify(token);\n}\n\nfunction parseCookie(header?: string): Record<string, string> {\n  if (!header) return {};\n  return header.split(';').reduce<Record<string, string>>((acc, part) => {\n    const [k, v] = part.trim().split('=');\n    if (k && v) acc[k] = v;\n    return acc;\n  }, {});\n}\n\nexport function parseSessionFromRequest(event: APIGatewayProxyEventV2): SessionContext | null {\n  const cookieHeader = event.headers.cookie || event.headers.Cookie;\n  const cookies = parseCookie(cookieHeader);\n  const token = cookies[COOKIE_NAME];\n  return parseSession(token);\n}\n\nexport function buildSessionCookie(token: string, secure = true) {\n  const attrs = [\n    `${COOKIE_NAME}=${token}`,\n    'HttpOnly',\n    'Path=/',\n    'SameSite=Lax',\n    ...(secure ? ['Secure'] : []),\n    'Max-Age=604800', // 7d\n  ];\n  return attrs.join('; ');\n}\n\nexport function buildClearCookie(secure = true) {\n  const attrs = [`${COOKIE_NAME}=; Path=/; Max-Age=0; HttpOnly; SameSite=Lax${secure ? '; Secure' : ''}`];\n  return attrs.join('; ');\n}\n\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;;;ACCA,6BAA+B;AAC/B,0BAAuC;;;ACEvC,IAAM,SAAS,QAAQ,IAAI,kBAAkB;;;ADE7C,IAAM,SAAS,IAAI,sCAAe,CAAC,CAAC;AAC7B,IAAM,YAAY,2CAAuB,KAAK,MAAM;AAIpD,SAAS,aAAa,YAAoB,MAAwC;AACvF,SAAO;AAAA,IACL;AAAA,IACA,SAAS,EAAE,gBAAgB,mBAAmB;AAAA,IAC9C,MAAM,KAAK,UAAU,IAAI;AAAA,EAC3B;AACF;AAUO,SAAS,GAAG,MAAe;AAChC,SAAO,aAAa,KAAK,IAAI;AAC/B;;;AD3BO,IAAM,UAAmB,YAAY;AAC1C,SAAO,GAAG,EAAE,IAAI,MAAM,SAAS,yBAAyB,QAAQ,UAAU,CAAC;AAC7E;",
  "names": []
}
