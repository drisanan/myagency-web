service: athlete-narrative-api
frameworkVersion: '4'

useDotenv: true

provider:
  name: aws
  runtime: nodejs20.x
  stage: ${env:STAGE, 'prod'}
  region: ${env:AWS_REGION, 'us-west-1'}
  environment:
    TABLE_NAME: ${env:TABLE_NAME, 'agency-narrative-crm'}
    SESSION_SECRET: ${env:SESSION_SECRET, '37c9a436-7ea8-4422-9f26-85192414b923'}
    AWS_NODEJS_CONNECTION_REUSE_ENABLED: 1
    NODE_OPTIONS: --enable-source-maps
    OPENAI_KEY: ${env:OPENAI_KEY}
    # Local development flag - empty in production, 'true' when running serverless-offline
    IS_OFFLINE: ${env:IS_OFFLINE, ''}
    FORMS_SECRET: ${env:FORMS_SECRET, 'ff58bc99-63a5-4493-83dc-6720cb3c7db7'}
    DEBUG_SESSION: ${env:DEBUG_SESSION, 'false'}
    GOOGLE_CLIENT_ID: ${env:GOOGLE_CLIENT_ID}
    GOOGLE_CLIENT_SECRET: ${env:GOOGLE_CLIENT_SECRET}
    GOOGLE_REDIRECT_URI: ${env:GOOGLE_REDIRECT_URI, 'https://api.myrecruiteragency.com/google/oauth/callback'}
    FRONTEND_URL: ${env:FRONTEND_URL, 'https://www.myrecruiteragency.com'}
    # Sentry error tracking
    SENTRY_DSN: ${env:SENTRY_DSN, ''}
    # S3 Media Bucket
    MEDIA_BUCKET: ${self:service}-media-${self:provider.stage}
  httpApi:
    cors:
      allowedOrigins:
        - https://www.myrecruiteragency.com
        - https://myrecruiteragency.com
        - https://master.d2yp6hyv6u0efd.amplifyapp.com
        - http://localhost:3000
        - http://localhost:3001
      allowedHeaders:
        - Content-Type
        - Authorization
        - Cookie
      allowedMethods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      allowCredentials: true
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - dynamodb:DescribeTable
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Query
            - dynamodb:Scan
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${env:TABLE_NAME, 'agency-narrative-crm'}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${env:TABLE_NAME, 'agency-narrative-crm'}/index/*
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
          Resource:
            - arn:aws:s3:::${self:service}-media-${self:provider.stage}/*
        - Effect: Allow
          Action:
            - ses:SendEmail
            - ses:SendRawEmail
          Resource: '*'

plugins:
  # serverless-esbuild removed because Serverless v4 bundles esbuild/TS by default
  - serverless-offline # Local development only - does not affect production deployments

custom:
  # Local development configuration (serverless offline)
  serverless-offline:
    httpPort: 3001
    lambdaPort: 3002
    noPrependStageInUrl: true  # Keep URLs clean: /auth/session instead of /local/auth/session
  resourcePrefix: ${env:RESOURCE_PREFIX, 'agn'}
  namingConvention: ${env:NAMING_CONVENTION, 'agn-resource-prd-region'}
  build:
    esbuild: true
    bundle: true

package:
  individually: true

functions:
  health:
    handler: infra/src/handlers/health.handler
    events:
      - httpApi:
          path: /health
          method: get
  authSession:
    handler: infra/src/handlers/auth.handler
    events:
      - httpApi:
          path: /auth/session
          method: any
  agencies:
    handler: infra/src/handlers/agencies.handler
    events:
      - httpApi:
          path: /agencies
          method: any
      - httpApi:
          path: /agencies/settings
          method: any
      - httpApi:
          path: /agencies/slug
          method: any
  clients:
    handler: infra/src/handlers/clients.handler
    events:
      - httpApi:
          path: /clients
          method: any
      - httpApi:
          path: /clients/{id}
          method: any
  lists:
    handler: infra/src/handlers/lists.handler
    events:
      - httpApi:
          path: /lists
          method: any
      - httpApi:
          path: /lists/{id}
          method: any
  listAssignments:
    handler: infra/src/handlers/list-assignments.handler
    events:
      - httpApi:
          path: /list-assignments
          method: any
  campaigns:
    handler: infra/src/handlers/campaigns.handler
    events:
      - httpApi:
          path: /campaigns
          method: any
  formsPublic:
    handler: infra/src/handlers/forms-public.handler
    events:
      - httpApi:
          path: /forms/issue
          method: any
      - httpApi:
          path: /forms/agency
          method: any
      - httpApi:
          path: /forms/submit
          method: any
      - httpApi:
          path: /forms/submissions
          method: any
      - httpApi:
          path: /forms/consume
          method: any
  gmail:
    handler: infra/src/handlers/gmail.handler
    events:
      - httpApi:
          path: /gmail/{action}
          method: any
  googleOauth:
    handler: infra/src/handlers/google-oauth.handler
    events:
      - httpApi:
          path: /google/oauth/url
          method: get
      - httpApi:
          path: /google/oauth/callback
          method: get
      - httpApi:
          path: /google/tokens
          method: post
      - httpApi:
          path: /google/tokens
          method: get
      - httpApi:
          path: /google/status
          method: get
      - httpApi:
          path: /google/refresh
          method: post
  ghlLogin:
    handler: infra/src/handlers/ghl-login.handler
    events:
      - httpApi:
          path: /auth/ghl-login
          method: any
  login:
    handler: infra/src/handlers/login.handler
    events:
      - httpApi:
          path: /auth/login
          method: any
  clientLogin:
    handler: infra/src/handlers/auth-client-login.handler
    events:
      - httpApi:
          path: /auth/client-login
          method: any
  agentLogin:
    handler: infra/src/handlers/auth-agent-login.handler
    events:
      - httpApi:
          path: /auth/agent-login
          method: any
  clientInterests:
    handler: infra/src/handlers/client-interests.handler
    events:
      - httpApi:
          path: /clients/{id}/interests
          method: get
  tasks:
    handler: infra/src/handlers/tasks.handler
    events:
      - httpApi:
          path: /tasks
          method: any
      - httpApi:
          path: /tasks/{id}
          method: any
  suggestions:
    handler: infra/src/handlers/suggestions.handler
    timeout: 30  # Increased for OpenAI API calls
    events:
      - httpApi:
          path: /suggestions
          method: any
      - httpApi:
          path: /suggestions/{id}
          method: any
  prompts:
    handler: infra/src/handlers/prompts.handler
    events:
      - httpApi:
          path: /prompts
          method: any
      - httpApi:
          path: /prompts/{id}
          method: any
      - httpApi:
          path: /ai/intro
          method: post
  profile:
    handler: infra/src/handlers/profile.handler
    events:
      - httpApi:
          path: /profile
          method: any
  profilePublic:
    handler: infra/src/handlers/profile-public.handler
    events:
      - httpApi:
          path: /athlete/{username}
          method: get
      - httpApi:
          path: /athlete/check-username
          method: get
  agents:
    handler: infra/src/handlers/agents.handler
    events:
      - httpApi:
          path: /agents
          method: any
      - httpApi:
          path: /agents/{id}
          method: any
  uploads:
    handler: infra/src/handlers/uploads.handler
    events:
      - httpApi:
          path: /uploads/presigned-url
          method: post
  linkForward:
    handler: infra/src/handlers/link-forward.handler
    timeout: 10
    events:
      - httpApi:
          path: /r
          method: get
      - httpApi:
          path: /track/click
          method: get
  emailMetrics:
    handler: infra/src/handlers/email-metrics.handler
    events:
      - httpApi:
          path: /email-metrics/send
          method: post
      - httpApi:
          path: /email-metrics/stats
          method: get
  notes:
    handler: infra/src/handlers/notes.handler
    events:
      - httpApi:
          path: /notes
          method: any
      - httpApi:
          path: /notes/{id}
          method: any
  coachNotes:
    handler: infra/src/handlers/coach-notes.handler
    events:
      - httpApi:
          path: /coach-notes
          method: any
      - httpApi:
          path: /coach-notes/{id}
          method: any
  taskTemplates:
    handler: infra/src/handlers/task-templates.handler
    events:
      - httpApi:
          path: /task-templates
          method: any
      - httpApi:
          path: /task-templates/{id}
          method: any
  applyTaskTemplate:
    handler: infra/src/handlers/task-templates.applyHandler
    events:
      - httpApi:
          path: /task-templates/apply
          method: post
  communications:
    handler: infra/src/handlers/communications.handler
    events:
      - httpApi:
          path: /communications
          method: any
      - httpApi:
          path: /communications/{id}
          method: any
  communicationThreads:
    handler: infra/src/handlers/communications.getThreadsHandler
    events:
      - httpApi:
          path: /communications/threads
          method: get
  profileViews:
    handler: infra/src/handlers/profile-views.handler
    events:
      - httpApi:
          path: /profile-views
          method: any
  profileViewsDigest:
    handler: infra/src/handlers/profile-views.digestHandler
    events:
      - httpApi:
          path: /profile-views/digest
          method: get
  activity:
    handler: infra/src/handlers/activity.handler
    events:
      - httpApi:
          path: /activity
          method: any
  activityReport:
    handler: infra/src/handlers/activity.reportHandler
    events:
      - httpApi:
          path: /activity/report
          method: get
  meetings:
    handler: infra/src/handlers/meetings.handler
    events:
      - httpApi:
          path: /meetings
          method: any
      - httpApi:
          path: /meetings/{id}
          method: any
  googleCalendar:
    handler: infra/src/handlers/google-calendar.handler
    events:
      - httpApi:
          path: /google/calendar/events
          method: any
      - httpApi:
          path: /google/calendar/events/{eventId}
          method: any

# NOTE: MediaBucket resources commented out - bucket already exists outside CloudFormation
# To re-enable, import the existing bucket into the stack first
# resources:
#   Resources:
#     MediaBucket:
#       Type: AWS::S3::Bucket
#       DeletionPolicy: Retain
#       Properties:
#         BucketName: ${self:service}-media-${self:provider.stage}
#         CorsConfiguration:
#           CorsRules:
#             - AllowedHeaders:
#                 - '*'
#               AllowedMethods:
#                 - PUT
#                 - GET
#               AllowedOrigins:
#                 - https://www.myrecruiteragency.com
#                 - https://myrecruiteragency.com
#                 - https://master.d2yp6hyv6u0efd.amplifyapp.com
#                 - http://localhost:3000
#                 - http://localhost:3001
#               MaxAge: 3000
#         PublicAccessBlockConfiguration:
#           BlockPublicAcls: false
#           BlockPublicPolicy: false
#           IgnorePublicAcls: false
#           RestrictPublicBuckets: false
#     MediaBucketPolicy:
#       Type: AWS::S3::BucketPolicy
#       Properties:
#         Bucket: !Ref MediaBucket
#         PolicyDocument:
#           Statement:
#             - Sid: PublicReadGetObject
#               Effect: Allow
#               Principal: '*'
#               Action:
#                 - s3:GetObject
#               Resource:
#                 - !Sub 'arn:aws:s3:::${MediaBucket}/*'

# ╔════════════════════════════════════════════════════════════════════════════╗
# ║  ⚠️  CRITICAL: DATABASE PROTECTION NOTICE                                  ║
# ╠════════════════════════════════════════════════════════════════════════════╣
# ║  The DynamoDB table 'agency-narrative-crm' is EXTERNALLY MANAGED with:    ║
# ║                                                                            ║
# ║  1. DELETION PROTECTION ENABLED - Cannot be deleted via AWS Console/CLI   ║
# ║  2. POINT-IN-TIME RECOVERY (PITR) - 35 days of continuous backups         ║
# ║  3. IAM DENY POLICY - Explicit deny on dynamodb:DeleteTable action        ║
# ║                                                                            ║
# ║  DO NOT:                                                                   ║
# ║  - Add a 'resources' section to recreate this table                       ║
# ║  - Delete the CloudFormation stack without retaining the table            ║
# ║  - Modify deletion protection settings                                    ║
# ║                                                                            ║
# ║  To restore from backup: aws dynamodb restore-table-to-point-in-time      ║
# ╚════════════════════════════════════════════════════════════════════════════╝

